import{at as T,j as l,au as E,av as c,ak as o,aw as v,l as p,e as L,ar as m,as as y,am as f,ax as S,ac as R,ay as O,az as C,i as _,aA as $}from"./vidstack-725a7f4d-95ea9c0b.js";import{VideoProvider as A}from"./vidstack-video-b2ce3e81.js";import{R as D}from"./vidstack-e4c18a8c-a68c38df.js";import"./app-92e2b39d.js";const I=h=>$(h);class b{constructor(t){this.va=null,this.Jg=null,this.A={},this.B=new Set,this.O=t}get instance(){return this.va}setup(t,i){this.Rf=i;const e=c(i.$state.streamType).includes("live"),r=c(i.$state.streamType).includes("ll-");this.va=new t({lowLatencyMode:r,backBufferLength:r?4:e?8:void 0,renderTextTracksNatively:!1,...this.A});const s=this.Kg.bind(this);for(const a of Object.values(t.Events))this.va.on(a,s);this.va.on(t.Events.ERROR,this._c.bind(this));for(const a of this.B)a(this.va);i.player.dispatch(new o("hls-instance",{detail:this.va})),this.va.attachMedia(this.O),this.va.on(t.Events.AUDIO_TRACK_SWITCHED,this.Lg.bind(this)),this.va.on(t.Events.LEVEL_SWITCHED,this.Mg.bind(this)),this.va.on(t.Events.LEVEL_LOADED,this.Ng.bind(this)),this.va.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Og.bind(this)),this.va.on(t.Events.CUES_PARSED,this.Pg.bind(this)),i.qualities[v.ab]=this.Qg.bind(this),p(i.qualities,"change",this.Rg.bind(this)),p(i.audioTracks,"change",this.Sg.bind(this)),this.Jg=L(this.Tg.bind(this))}Tg(){if(!this.Rf.$state.live())return;const t=new D(this.Ug.bind(this));return t.Nb(),t.Ob.bind(t)}Ug(){var t;this.Rf.$state.liveSyncPosition.set(((t=this.va)==null?void 0:t.liveSyncPosition)??1/0)}Kg(t,i){var e;(e=this.Rf.player)==null||e.dispatch(new o(I(t),{detail:i}))}Og(t,i){const e=new o(t,{detail:i});let r=-1;for(let s=0;s<i.tracks.length;s++){const a=i.tracks[s],n=a.subtitleTrack??a.closedCaptions,u=new m({id:`hls-${a.kind}${s}`,src:n==null?void 0:n.url,label:a.label,language:n==null?void 0:n.lang,kind:a.kind});u[y.za]=2,u[y.Oa]=()=>{u.mode==="showing"?(this.va.subtitleTrack=s,r=s):r===s&&(this.va.subtitleTrack=-1,r=-1)},a.default&&u.setMode("showing",e),this.Rf.textTracks.add(u,e)}}Pg(t,i){const e=this.Rf.textTracks.getById(`hls-${i.track}`);if(!e)return;const r=new o(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,r)}Lg(t,i){const e=this.Rf.audioTracks[i.id];e&&this.Rf.audioTracks[f.R](e,!0,new o(t,{detail:i}))}Mg(t,i){const e=this.Rf.qualities[i.level];e&&this.Rf.qualities[f.R](e,!0,new o(t,{detail:i}))}Ng(t,i){if(this.Rf.$state.canPlay())return;const{type:e,live:r,totalduration:s,targetduration:a}=i.details,n=new o(t,{detail:i});this.Rf.delegate.w("stream-type-change",{detail:r?e==="EVENT"&&Number.isFinite(s)&&a>=10?"live:dvr":"live":"on-demand",trigger:n}),this.Rf.delegate.w("duration-change",{detail:s,trigger:n});const u=this.va.media;this.va.currentLevel===-1&&this.Rf.qualities[v.$a](!0,n);for(const d of this.va.audioTracks)this.Rf.audioTracks[f.h]({id:d.id+"",label:d.name,language:d.lang||"",kind:"main"},n);for(const d of this.va.levels)this.Rf.qualities[f.h]({width:d.width,height:d.height,codec:d.codecSet,bitrate:d.bitrate},n);u.dispatchEvent(new o("canplay",{trigger:n}))}_c(t,i){var e,r,s;if(i.fatal)switch(i.type){case"networkError":(e=this.va)==null||e.startLoad();break;case"mediaError":(r=this.va)==null||r.recoverMediaError();break;default:(s=this.va)==null||s.destroy(),this.va=null;break}}Qg(){this.va&&(this.va.currentLevel=-1)}Rg(){const{qualities:t}=this.Rf;!this.va||t.auto||(this.va[t.switch+"Level"]=t.selectedIndex,S&&(this.O.currentTime=this.O.currentTime))}Sg(){const{audioTracks:t}=this.Rf;this.va&&this.va.audioTrack!==t.selectedIndex&&(this.va.audioTrack=t.selectedIndex)}C(){var t,i;this.Rf&&(this.Rf.qualities[v.ab]=void 0),(t=this.va)==null||t.destroy(),this.va=null,(i=this.Jg)==null||i.call(this),this.Jg=null}}class N{constructor(t,i,e){this.hf=t,this.Rf=i,this.Xg=e,this.Vg()}async Vg(){const t={onLoadStart:this.tf.bind(this),onLoaded:this.Cf.bind(this),onLoadError:this.Wg.bind(this)};let i=await H(this.hf,t);if(R(i)&&!l(this.hf)&&(i=await x(this.hf,t)),!i)return null;if(!i.isSupported()){const e="[vidstack]: `hls.js` is not supported in this environment";return this.Rf.player.dispatch(new o("hls-unsupported")),this.Rf.delegate.w("error",{detail:{message:e,code:4}}),null}return i}tf(){this.Rf.player.dispatch(new o("hls-lib-load-start"))}Cf(t){this.Rf.player.dispatch(new o("hls-lib-loaded",{detail:t})),this.Xg(t)}Wg(t){const i=O(t);this.Rf.player.dispatch(new o("hls-lib-load-error",{detail:i})),this.Rf.delegate.w("error",{detail:{message:i.message,code:4}})}}async function x(h,t={}){var i,e,r,s,a;if(!R(h)){if((i=t.onLoadStart)==null||i.call(t),h.prototype&&h.prototype!==Function)return(e=t.onLoaded)==null||e.call(t,h),h;try{const n=(r=await h())==null?void 0:r.default;if(n&&n.isSupported)(s=t.onLoaded)==null||s.call(t,n);else throw Error("");return n}catch(n){(a=t.onLoadError)==null||a.call(t,n)}}}async function H(h,t={}){var i,e,r;if(l(h)){(i=t.onLoadStart)==null||i.call(t);try{if(await C(h),!_(window.Hls))throw Error("");const s=window.Hls;return(e=t.onLoaded)==null||e.call(t,s),s}catch(s){(r=t.onLoadError)==null||r.call(t,s)}}}const q="https://cdn.jsdelivr.net",g=class g extends A{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.z=null,this.x=new b(this.video),this.y=`${q}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.z}get instance(){return this.x.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.x.A}set config(t){this.x.A=t}get library(){return this.y}set library(t){this.y=t}preconnect(){l(this.y)&&E(this.y)}setup(t){super.setup(t),new N(this.y,t,i=>{this.z=i,this.x.setup(i,t),t.delegate.w("provider-setup",{detail:this});const e=c(t.$state.source);e&&this.loadSource(e)})}async loadSource(t,i){var e;l(t.src)&&(this.t.preload=i||"",(e=this.x.instance)==null||e.loadSource(t.src),this.u=t)}onInstance(t){const i=this.x.instance;return i&&t(i),this.x.B.add(t),()=>this.x.B.delete(t)}destroy(){this.x.C()}};g.supported=T();let w=g;export{w as HLSProvider};
