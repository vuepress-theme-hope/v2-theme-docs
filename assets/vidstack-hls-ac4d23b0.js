import{at as E,j as c,au as m,av as f,ak as h,aw as T,l as v,e as L,ar as S,as as g,am as l,ax as U,ac as w,ay as b,az as $,i as _,aA as D}from"./vidstack-1a42d66e-b64007f4.js";import{VideoProvider as I}from"./vidstack-video-61ecece0.js";import{R as C}from"./vidstack-abfffb3d-345e7fc4.js";import"./app-fe94cd90.js";const R=o=>D(o);class q{constructor(t){this.T=null,this.V=null,this.d={},this.e=new Set,this.v=t}get instance(){return this.T}setup(t,i){this.U=i;const e=f(i.$state.streamType).includes("live"),r=f(i.$state.streamType).includes("ll-");this.T=new t({lowLatencyMode:r,backBufferLength:r?4:e?8:void 0,renderTextTracksNatively:!1,...this.d});const s=this.W.bind(this);for(const a of Object.values(t.Events))this.T.on(a,s);this.T.on(t.Events.ERROR,this.X.bind(this));for(const a of this.e)a(this.T);i.player.dispatch(new h("hls-instance",{detail:this.T})),this.T.attachMedia(this.v),this.T.on(t.Events.AUDIO_TRACK_SWITCHED,this.Y.bind(this)),this.T.on(t.Events.LEVEL_SWITCHED,this.Z.bind(this)),this.T.on(t.Events.LEVEL_LOADED,this._.bind(this)),this.T.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.$.bind(this)),this.T.on(t.Events.CUES_PARSED,this.aa.bind(this)),i.qualities[T.ba]=this.ca.bind(this),v(i.qualities,"change",this.da.bind(this)),v(i.audioTracks,"change",this.ea.bind(this)),this.V=L(this.fa.bind(this))}fa(){if(!this.U.$state.live())return;const t=new C(this.ga.bind(this));return t.ia(),t.ja.bind(t)}ga(){var t;this.U.$state.liveSyncPosition.set(((t=this.T)==null?void 0:t.liveSyncPosition)??1/0)}W(t,i){var e;(e=this.U.player)==null||e.dispatch(new h(R(t),{detail:i}))}$(t,i){const e=new h(t,{detail:i});let r=-1;for(let s=0;s<i.tracks.length;s++){const a=i.tracks[s],n=a.subtitleTrack??a.closedCaptions,u=new S({id:`hls-${a.kind}${s}`,src:n==null?void 0:n.url,label:a.label,language:n==null?void 0:n.lang,kind:a.kind});u[g.ka]=2,u[g.la]=()=>{u.mode==="showing"?(this.T.subtitleTrack=s,r=s):r===s&&(this.T.subtitleTrack=-1,r=-1)},a.default&&u.setMode("showing",e),this.U.textTracks.add(u,e)}}aa(t,i){const e=this.U.textTracks.getById(`hls-${i.track}`);if(!e)return;const r=new h(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,r)}Y(t,i){const e=this.U.audioTracks[i.id];e&&this.U.audioTracks[l.ha](e,!0,new h(t,{detail:i}))}Z(t,i){const e=this.U.qualities[i.level];e&&this.U.qualities[l.ha](e,!0,new h(t,{detail:i}))}_(t,i){if(this.U.$state.canPlay())return;const{type:e,live:r,totalduration:s,targetduration:a}=i.details,n=new h(t,{detail:i});this.U.delegate.f("stream-type-change",{detail:r?e==="EVENT"&&Number.isFinite(s)&&a>=10?"live:dvr":"live":"on-demand",trigger:n}),this.U.delegate.f("duration-change",{detail:s,trigger:n});const u=this.T.media;this.T.currentLevel===-1&&this.U.qualities[T.ma](!0,n);for(const d of this.T.audioTracks)this.U.audioTracks[l.F]({id:d.id+"",label:d.name,language:d.lang||"",kind:"main"},n);for(const d of this.T.levels)this.U.qualities[l.F]({width:d.width,height:d.height,codec:d.codecSet,bitrate:d.bitrate},n);u.dispatchEvent(new h("canplay",{trigger:n}))}X(t,i){var e,r,s;if(i.fatal)switch(i.type){case"networkError":(e=this.T)==null||e.startLoad();break;case"mediaError":(r=this.T)==null||r.recoverMediaError();break;default:(s=this.T)==null||s.destroy(),this.T=null;break}}ca(){this.T&&(this.T.currentLevel=-1)}da(){const{qualities:t}=this.U;!this.T||t.auto||(this.T[t.switch+"Level"]=t.selectedIndex,U&&(this.v.currentTime=this.v.currentTime))}ea(){const{audioTracks:t}=this.U;this.T&&this.T.audioTrack!==t.selectedIndex&&(this.T.audioTrack=t.selectedIndex)}i(){var t,i;this.U&&(this.U.qualities[T.ba]=void 0),(t=this.T)==null||t.destroy(),this.T=null,(i=this.V)==null||i.call(this),this.V=null}}class V{constructor(t,i,e){this.na=t,this.U=i,this.sa=e,this.oa()}async oa(){const t={onLoadStart:this.pa.bind(this),onLoaded:this.qa.bind(this),onLoadError:this.ra.bind(this)};let i=await O(this.na,t);if(w(i)&&!c(this.na)&&(i=await H(this.na,t)),!i)return null;if(!i.isSupported()){const e="[vidstack]: `hls.js` is not supported in this environment";return this.U.player.dispatch(new h("hls-unsupported")),this.U.delegate.f("error",{detail:{message:e,code:4}}),null}return i}pa(){this.U.player.dispatch(new h("hls-lib-load-start"))}qa(t){this.U.player.dispatch(new h("hls-lib-loaded",{detail:t})),this.sa(t)}ra(t){const i=b(t);this.U.player.dispatch(new h("hls-lib-load-error",{detail:i})),this.U.delegate.f("error",{detail:{message:i.message,code:4}})}}async function H(o,t={}){var i,e,r,s,a;if(!w(o)){if((i=t.onLoadStart)==null||i.call(t),o.prototype&&o.prototype!==Function)return(e=t.onLoaded)==null||e.call(t,o),o;try{const n=(r=await o())==null?void 0:r.default;if(n&&n.isSupported)(s=t.onLoaded)==null||s.call(t,n);else throw Error("");return n}catch(n){(a=t.onLoadError)==null||a.call(t,n)}}}async function O(o,t={}){var i,e,r;if(c(o)){(i=t.onLoadStart)==null||i.call(t);try{if(await $(o),!_(window.Hls))throw Error("");const s=window.Hls;return(e=t.onLoaded)==null||e.call(t,s),s}catch(s){(r=t.onLoadError)==null||r.call(t,s)}}}const j="https://cdn.jsdelivr.net",p=class p extends I{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.c=null,this.a=new q(this.video),this.b=`${j}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.c}get instance(){return this.a.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.a.d}set config(t){this.a.d=t}get library(){return this.b}set library(t){this.b=t}preconnect(){c(this.b)&&m(this.b)}setup(t){super.setup(t),new V(this.b,t,i=>{this.c=i,this.a.setup(i,t),t.delegate.f("provider-setup",{detail:this});const e=f(t.$state.source);e&&this.loadSource(e)})}async loadSource(t,i){var e;c(t.src)&&(this.g.preload=i||"",(e=this.a.instance)==null||e.loadSource(t.src),this.h=t)}onInstance(t){const i=this.a.instance;return i&&t(i),this.a.e.add(t),()=>this.a.e.delete(t)}destroy(){this.a.i()}};p.supported=E();let y=p;export{y as HLSProvider};
